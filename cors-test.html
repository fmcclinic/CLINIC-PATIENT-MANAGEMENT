<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm tra CORS với Google Apps Script</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .btn {
            padding: 10px 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background-color: #3367d6;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            white-space: pre-wrap;
            background-color: #f5f5f5;
            overflow-y: auto;
            max-height: 400px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .proxy-options {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        h2 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Kiểm tra CORS với Google Apps Script</h1>
    
    <div class="input-group">
        <label for="apiUrl">API URL:</label>
        <input type="text" id="apiUrl" value="https://script.google.com/macros/s/AKfycbx-TQojT-M16MZy50zy1lZzU5_QPPV1rilGM6DeH1r39FmWxHJJGr-RlpB2r-4ZMaKI/exec" placeholder="Nhập URL API để kiểm tra">
    </div>
    
    <div class="input-group">
        <label for="actionParam">Tham số action (không bắt buộc):</label>
        <input type="text" id="actionParam" value="getAllPatients" placeholder="Ví dụ: getAllPatients">
    </div>
    
    <h2>Phương pháp gọi API trực tiếp</h2>
    <div>
        <button id="btnFetch" class="btn">Thử fetch API thông thường</button>
        <button id="btnNoCors" class="btn">Thử fetch với mode: 'no-cors'</button>
        <button id="btnJsonp" class="btn">Thử dùng JSONP</button>
    </div>
    
    <h2>Phương pháp sử dụng CORS Proxy</h2>
    <div class="proxy-options">
        <div class="input-group">
            <label for="proxyUrl">Chọn CORS Proxy:</label>
            <select id="proxyUrl" class="form-control">
                <option value="https://api.allorigins.win/raw?url=">api.allorigins.win</option>
                <option value="https://corsproxy.io/?">corsproxy.io</option>
                <option value="https://cors-anywhere.herokuapp.com/">cors-anywhere.herokuapp.com</option>
                <option value="custom">Tùy chỉnh...</option>
            </select>
        </div>
        
        <div id="customProxyDiv" class="input-group" style="display:none;">
            <label for="customProxy">Proxy tùy chỉnh:</label>
            <input type="text" id="customProxy" placeholder="Nhập URL proxy tùy chỉnh (ví dụ: https://your-proxy.com/?url=)">
        </div>
        
        <button id="btnProxy" class="btn">Thử gọi API qua CORS Proxy</button>
    </div>
    
    <h2>Kết quả:</h2>
    <div id="output">Kết quả sẽ hiển thị ở đây...</div>
    
    <script>
        // Các phần tử DOM
        const apiUrlInput = document.getElementById('apiUrl');
        const actionParamInput = document.getElementById('actionParam');
        const output = document.getElementById('output');
        const proxySelect = document.getElementById('proxyUrl');
        const customProxyDiv = document.getElementById('customProxyDiv');
        const customProxyInput = document.getElementById('customProxy');
        
        // Hiển thị/ẩn input proxy tùy chỉnh
        proxySelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customProxyDiv.style.display = 'block';
            } else {
                customProxyDiv.style.display = 'none';
            }
        });
        
        // Hàm hiển thị thông báo
        function log(message, isError = false) {
            const className = isError ? 'error' : 'success';
            output.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
            // Cuộn xuống dưới
            output.scrollTop = output.scrollHeight;
        }
        
        // Xóa kết quả trước đó
        function clearOutput() {
            output.innerHTML = '';
        }
        
        // Lấy URL API đầy đủ (với tham số action nếu có)
        function getFullApiUrl() {
            let url = apiUrlInput.value.trim();
            const action = actionParamInput.value.trim();
            
            if (action) {
                url += (url.includes('?') ? '&' : '?') + `action=${action}`;
            }
            
            return url;
        }
        
        // Lấy URL proxy đã chọn
        function getSelectedProxy() {
            if (proxySelect.value === 'custom') {
                return customProxyInput.value.trim();
            }
            return proxySelect.value;
        }
        
        // Phương thức 1: Fetch thông thường
        document.getElementById('btnFetch').addEventListener('click', function() {
            clearOutput();
            const apiUrl = getFullApiUrl();
            log(`Đang gọi API với fetch thông thường...`);
            log(`URL: ${apiUrl}`);
            
            fetch(apiUrl)
                .then(response => {
                    log(`Nhận được phản hồi với status: ${response.status} ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    log(`Dữ liệu nhận được: ${JSON.stringify(data, null, 2)}`);
                })
                .catch(error => {
                    log(`Lỗi: ${error.message}`, true);
                });
        });
        
        // Phương thức 2: Fetch với mode no-cors
        document.getElementById('btnNoCors').addEventListener('click', function() {
            clearOutput();
            const apiUrl = getFullApiUrl();
            log(`Đang gọi API với fetch mode no-cors...`);
            log(`URL: ${apiUrl}`);
            
            fetch(apiUrl, {
                method: 'GET',
                mode: 'no-cors'
            })
                .then(response => {
                    log(`Nhận được phản hồi với type: ${response.type}`);
                    log(`Status: ${response.status}`);
                    log("Lưu ý: Khi sử dụng mode 'no-cors', bạn không thể đọc nội dung phản hồi");
                })
                .catch(error => {
                    log(`Lỗi: ${error.message}`, true);
                });
        });
        
        // Phương thức 3: JSONP
        document.getElementById('btnJsonp').addEventListener('click', function() {
            clearOutput();
            const apiUrl = getFullApiUrl();
            log(`Đang gọi API với JSONP...`);
            log(`URL: ${apiUrl}`);
            
            // Tạo callback function name động
            const callbackName = 'jsonpCallback' + Date.now();
            
            // Tạo global callback function
            window[callbackName] = function(data) {
                log(`Đã nhận được dữ liệu từ JSONP callback`);
                log(`Dữ liệu: ${JSON.stringify(data, null, 2)}`);
                
                // Dọn dẹp
                delete window[callbackName];
                document.body.removeChild(script);
            };
            
            // Thêm tham số callback vào URL
            const jsonpUrl = apiUrl + (apiUrl.includes('?') ? '&' : '?') + `callback=${callbackName}`;
            
            // Tạo script element
            const script = document.createElement('script');
            script.src = jsonpUrl;
            script.onerror = function() {
                log(`Lỗi tải script JSONP: ${jsonpUrl}`, true);
                delete window[callbackName];
            };
            
            document.body.appendChild(script);
            
            log(`Script JSONP đã được thêm vào DOM: ${jsonpUrl}`);
        });
        
        // Phương thức 4: CORS Proxy
        document.getElementById('btnProxy').addEventListener('click', function() {
            clearOutput();
            const apiUrl = getFullApiUrl();
            const proxy = getSelectedProxy();
            
            if (!proxy) {
                log("Vui lòng chọn hoặc nhập URL proxy", true);
                return;
            }
            
            const proxyUrl = proxy + encodeURIComponent(apiUrl);
            
            log(`Đang gọi API thông qua CORS Proxy...`);
            log(`Proxy: ${proxy}`);
            log(`API URL: ${apiUrl}`);
            log(`URL đầy đủ: ${proxyUrl}`);
            
            fetch(proxyUrl)
                .then(response => {
                    log(`Nhận được phản hồi với status: ${response.status} ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    log(`Dữ liệu nhận được: ${JSON.stringify(data, null, 2)}`);
                })
                .catch(error => {
                    log(`Lỗi: ${error.message}`, true);
                });
        });
        
        // Ghi chú khi trang tải
        window.onload = function() {
            log("Trang đã tải. Nhập URL API và nhấn các nút để kiểm tra các phương pháp khác nhau.");
        };
    </script>
</body>
</html>